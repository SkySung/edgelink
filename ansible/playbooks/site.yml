---
- name: Provision Edge Node (Raspberry Pi)
  hosts: edge_nodes
  become: yes
  vars:
    # 這裡只留系統設定，敏感變數已經搬到 inventory/group_vars/all/ 去了
    sysctl_config:
      - { name: 'net.ipv4.ip_forward', value: '1' }

  tasks:
    # -------------------------------------------------------
    # 1. System Preparation
    # -------------------------------------------------------
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install essential networking tools
      apt:
        name:
          - wireguard
          - openresolv
          - qrencode
        state: present

    # -------------------------------------------------------
    # 2. Kernel Configuration
    # -------------------------------------------------------
    - name: Enable IPv4 forwarding in sysctl
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        reload: yes
      loop: "{{ sysctl_config }}"

# -------------------------------------------------------
    # 3. WireGuard Configuration (Updated)
    # -------------------------------------------------------
    - name: Generate WireGuard configuration from template
      template:
        # 修改這裡：加上 "../templates/"
        src: ../templates/wg0.conf.j2
        dest: /etc/wireguard/wg0.conf
        owner: root
        group: root
        mode: '0600'
      notify: Restart WireGuard

    # -------------------------------------------------------
    # 4. Service Management
    # -------------------------------------------------------
    - name: Enable WireGuard service
      systemd:
        name: wg-quick@wg0
        enabled: yes
        state: started

  # -------------------------------------------------------
  # Handlers (事件驅動區)
  # -------------------------------------------------------
  handlers:
    - name: Restart WireGuard
      systemd:
        name: wg-quick@wg0
        state: restarted